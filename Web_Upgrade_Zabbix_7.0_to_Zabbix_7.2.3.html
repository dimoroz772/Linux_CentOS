<head>
    <title>Upgrade Zabbix 7.0 to Zabbix 7.2.3</title>
    <link rel="shortcut icon" href="./CentOS_Logo.png" type="image/png">
  </head>
   <head>
    <meta charset="utf-8">
   </head>
  <style>
  .neonText1 {
    color: #87CEFA;
    text-shadow:
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1;
  }
  .neonText2 {
    color: #00FF00;
    text-shadow:
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400;
  }
  .neonText3 {
    color: #ff0000;
    text-shadow:
        0 0 1px #640000,
        0 0 1px #640000,
        0 0 1px #640000,
        0 0 1px #640000,
        0 0 1px #640000,
        0 0 1px #640000,
        0 0 1px #640000,
        0 0 1px #640000;
  }
  /* Additional styling */
  body{
      background-color: black;
      background-repeat: no-repeat;
      background-size: cover;
      background-attachment: fixed;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      color: #cfcfcf;
  }
  a {
      text-decoration: none;
  }
  p {
    text-indent: 1.5em;
    font-family: monospace;
    font-weight: 500;
    white-space: pre;
    line-height: 2;
    letter-spacing: 1px;
  }
  </style>
  <div class="container">
  <p class="neonText1">
  Развертывание сервера с свободной системой мониторинга статусов разнообразных сервисов компьютерной сети, серверов и сетевого оборудования Zabbix на ОС Linux CentOS Stream 9
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  Все описанные ниже действия выполнялись под пользователем root
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  Всем привет! Для реализации данного проекта мне потребовалось:
  1) Прописать статические IP-адреса;
  2) Обновить пакеты ОС Linux CentOS Stream 9 до последней версии;
  3) Установить дополнительные пакеыты yum-utils и nano;
  4) Установить и настроить Apache;
  5) Установить и настроить PHP 8.3;
  6) Установить и настроить MariaDB Server;
  7) Установить и настроить Zabbix 7.2.3;
  7.1) Экспорт БД из MySQL;
  7.2) Импорт БД в MySQL;
  7.3) Настройка конфигурационных файлов;
  8) Настройка/установка Zabbix через Zabbix Web-интерфейс.
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  Предисловие:
  ------------
  Nano — это консольный текстовый редактор для UNIX и Unix-подобных операционных систем, основанный на библиотеке curses и распространяемый под лицензией GNU GPL.
  ------------
  SELinux — реализация системы принудительного контроля доступа, которая может работать параллельно с классической избирательной системой контроля доступа.
  ------------
  NMTUI — это инструмент командной строки, который используется для настройки сети в системах Gnu / Linux. При запуске он вызывает графический текстовый 
  интерфейс, который помогает пользователям легко и эффективно настраивать сетевые интерфейсы.
  ------------
  Zabbix — это свободная система мониторинга статусов разнообразных сервисов компьютерной сети, серверов и сетевого оборудования.
  ------------
  Apache HTTP-сервер — это свободный веб-сервер.
  ------------
  MariaDB — это ответвление от системы управления базами данных MySQL, разрабатываемое сообществом под лицензией GNU GPL.
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  1) Для избежания потери связи с АРМ/VM, нужно позаботиться о статической IP-адресации. Её можно настроить как на самой АРМ/VM, так и на самом сетевом 
  устройстве. Статическую адресацию можно прописать с помощью инструмента командной строки nmtui.
  ------------
  <a class="neonText2">yum install -y NetworkManager-tui</a> |#|#| Установка пакета "nmtui" для настройки сети на АРМ/VM
  ------------
  Гайд по тому, как пользоваться инструментом nmtui, вы можете посмотреть в интернете.
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  2) Обновление пакетов системы.
  ------------
  <a class="neonText2">yum update -y && yum upgrade -y</a> |#|#| Поиск и обновление пакетов системы
  ------------
  <a class="neonText2">reboot</a> |#|#| Команда для перезагрузки АРМ/VM
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  3) Установка дополнительных пакетов yum-utils и nano.
  ------------
  <a class="neonText2">yum install -y yum-utils nano</a> |#|#| Команда для установки пакета "yum-utils" и "nano"
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  4) Установка и настройка Apache.
  ------------
  <a class="neonText2">yum install -y httpd</a> |#|#| Команда для установки пакета "httpd"
  ------------
  <a class="neonText2">mv /etc/httpd/conf.d/welcome.conf /etc/httpd/conf.d/welcome.conf.org</a> |#|#| Команда для переименования файла "welcome.conf" в "welcome.conf.org"
  ------------
  <a class="neonText2">nano /etc/httpd/conf/httpd.conf</a> |#|#| Команда для открытия файла "httpd.conf" в текстовом редакторе Nano
  ------------
  Приведите прописанные ниже строки в файле "httpd.conf" к следующему виду:
  <a class="neonText2">
  ServerAdmin root@zabbix.organization
  ServerName www.zabbix.organization:80
  Options FollowSymLinks
  AllowOverride All
  DirectoryIndex index.html index.php index.cgi
  # server's response header
  ServerTokens Prod</a>
  ------------
  Расшифровка редактирования строк↑↑↑:
  
  ServerAdmin root@zabbix.organization |#|#| строка 91: можете поменять адрес электронной почты администратора(сток: ServerAdmin root@localhost)
  ServerName www.zabbix.organization:80 |#|#| строка 100: можете поменять имя вашего сервера
  Options FollowSymLinks |#|#| строка 149: замените Options Indexes FollowSymLinks на Options FollowSymLinks
  AllowOverride All |#|#| строка 156: замените AllowOverride None на AllowOverride All
  DirectoryIndex index.html index.php index.cgi |#|#| строка 169: дописать к DirectoryIndex index.html ещё index.php index.cgi
  ------------
  # server's response header  |#|#| \
                              |#|#|  --- добавить данные строки в конец файла
  ServerTokens Prod           |#|#| /
  ------------
  <a class="neonText2">systemctl enable --now httpd</a> |#|#| Команда для запуска указанного юнита и добавления службы "httpd" в автозагрузку
  ------------
  <a class="neonText2">firewall-cmd --add-service=http</a> |#|#| Команда для открытия доступа трафику через протокол HTTP
  <a class="neonText2">firewall-cmd --runtime-to-permanent</a> |#|#| Команда для сохранения конфигурации на межсетевом экране
  ------------
  <a class="neonText2">nano /var/www/html/index.html</a> |#|#| Данной командой создадим текстовый файл "index.html"
  ------------
  Приведите текстовый файл "index.html" к следующему виду и не забудьте сохранить файл перед закрытием:
  <a class="neonText2">
  &lt;html&gt;
  &lt;body&gt;
  &lt;div style="width: 100%; font-size: 40px; font-weight: bold; text-align: center;"&gt;
  Zabbix 7.2.3
  &lt;/div&gt;
  &lt;/body&gt;
  &lt;/html&gt;</a>
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  5) Установка и настройка PHP 8.3.
  ------------
  <a class="neonText2">yum module list php</a> |#|#| Команда для просмотра доступных модулей пакетов PHP
  ------------
  <a class="neonText2">yum module -y reset php</a> |#|#| Команда для отключения активного модуля пакетов PHP
  ------------
  <a class="neonText2">yum module -y enable php:8.3</a> |#|#| Команда для включения модуля пакетов PHP версии 8.3
  ------------
  <a class="neonText2">yum module -y install php:8.3/common</a> |#|#| Команда для установки модуля пакетов PHP версии 8.3
  ------------
  <a class="neonText2">php -v</a> |#|#| Команда для проверки установленной версии PHP
  ------------
  <a class="neonText2">echo '&lt;?php echo `php -i`."\n"; ?&gt;' > php_test.php</a> |#|#| Создание файла "php_test.php" с тестовым сценарием для проверки PHP
  ------------
  <a class="neonText2">php php_test.php | head</a> |#|#| Команда для запуска скрипта "php_test.php" с последующим экранированием вывода в консоль
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  6) Установка и настройка MariaDB Server.
  ------------
  <a class="neonText2">yum install -y mariadb-server</a> |#|#| Команда для установки пакета "mariadb-server"
  ------------
  <a class="neonText2">nano /etc/my.cnf.d/charset.cnf</a> |#|#| Данной командой создадим/отредактируем текстовый файл "charset.cnf"
  ------------
  Приведите конфигурационных файл к следующему виду и сохраните:
  <a class="neonText2">
  [mysqld]
  character-set-server = utf8mb4
  
  [client]
  default-character-set = utf8mb4</a>
  ------------
  <a class="neonText2">systemctl enable --now mariadb</a> |#|#| Команда для запуска указанного юнита и добавления службы "mariadb" в автозагрузку
  ------------
  <a class="neonText2">firewall-cmd --add-service=mysql</a> |#|#| Команда для открытия доступа к серверу MariaDB с удаленных хостов
  ------------
  <a class="neonText2">firewall-cmd --runtime-to-permanent</a> |#|#| Команда для сохранения конфигурации на межсетевом экране
  ------------
  <a class="neonText2">mysql_secure_installation</a> |#|#| Команда для выполнения первоначальной настройки MariaDB
  ------------
  План настройки MariaDB:
  
  1. Задайте пароль для MariaDB;
  2. Switch to unix_socket authentication [Y/n] n
  3. Change the root password? [Y/n] n
  4. Remove anonymous users? [Y/n] y
  5. Disallow root login remotely? [Y/n] y
  6. Remove test database and access to it? [Y/n] y
  7. Reload privilege tables now? [Y/n] y
  ------------
  Tutorial for MariaDB↓↓↓
  ------------
  <a class="neonText3">mysql</a> |#|#| Команда для подключения к MariaDB с помощью пользователя root
  ------------
  <a class="neonText3">show grants for root@localhost;</a> |#|#| Команда для вывода грантов на root@localhost
  ------------
  <a class="neonText3">select user,host,password from mysql.user;</a> |#|#| Команда для вывода списка пользователей
  ------------
  <a class="neonText3">show databases;</a> |#|#| Команда для вывода списка баз данных
  ------------
  <a class="neonText3">create database test_database;</a> |#|#| Команда для создания базы данных с названием "test_database"
  ------------
  <a class="neonText3">create table test_database.test_table (id int, name varchar(50), address varchar(50), primary key (id));</a> |#|#| Команда для создания тестовой таблицы в базе данных "test_database"
  ------------
  <a class="neonText3">insert into test_database.test_table(id, name, address) values("001", "CentOS", "Hiroshima");</a> |#|#| Команда для заполнения данных в таблице "test_database"
  ------------
  <a class="neonText3">select * from test_database.test_table;</a> |#|#| Команда для вывода содержимого в базе данных "test_database"
  ------------
  <a class="neonText3">drop database test_database;</a> |#|#| Команда для удаления базы данных "test_database"
  ------------
  <a class="neonText3">exit</a> |#|#| Команда для выхода из MariaDB
  ------------
  <a class="neonText3">systemctl stop mariadb</a> |#|#| Команда для остановки службы "MariaDB"
  ------------
  <a class="neonText3">rm -rf /var/lib/mysql/*</a> |#|#| Команда для очистки каталога "/var/lib/mysql/"
  ------------
  <a class="neonText3">mysql_install_db --datadir=/var/lib/mysql --user=mysql</a> |#|#| Команда для инициализации каталога данных MySQL
  ------------
  <a class="neonText3">systemctl start mariadb</a> |#|#| Команда для запуска службы "MariaDB"
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  7) Установка и настройка Zabbix 7.2.3.
  ------------
  <a class="neonText2">yum install -y php-mysqlnd php-gd php-xml php-bcmath php-ldap</a> |#|#| Команда для установки необходимых пакетов "PHP"
  ------------
  <a class="neonText2">rpm -Uvh https://repo.zabbix.com/zabbix/7.2/release/centos/9/noarch/zabbix-release-latest-7.2.el9.noarch.rpm</a> |#|#| Команда для подключения Zabbix-репозитория
  ------------
  <a class="neonText2">yum install -y zabbix-server-mysql zabbix-web-mysql zabbix-apache-conf zabbix-sql-scripts zabbix-selinux-policy zabbix-agent2</a> |#|#| Команда установки пакетов Zabbix Server-а
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  7.1) Экспорт БД из MySQL.
  ------------
  <a class="neonText3">systemctl stop zabbix-server zabbix-agent</a> |#|#| Команда для остановки сервисов zabbix-server и zabbix-agent
  ------------
  <a class="neonText3">mkdir /DB/</a> |#|#| Команда для создания в корне папки "DB"
  ------------
  <a class="neonText3">/usr/bin/mysqldump --opt -v --databases zabbix -uzabbix -p'zabbixpassword' | /usr/bin/gzip -c > /DB/zabbix.sql.gz</a> |#|#| Команда для выполнения РК БД Zabbix в MySQL на старой ВМ
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  Самостоятельно выполните перенос БД "Zabbix" из старой ВМ с новую.
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  7.2) Импорт БД в MySQL.
  ------------
  <a class="neonText2">mysql -u root -p < /DB/zabbix_dump.sql</a> |#|#| Команда для выполнения импортирования БД Zabbix в MySQL на новой ВМ
  ------------
  После того, как БД была импортирована в MySQL, также создайте в системе управления базами данных нового пользователя Zabbix, как и на старой ВМ.
  ------------
  <a class="neonText2">mysql -u root -p</a> |#|#| Команда для входа в систему управления БД под пользователем "root"
  ------------
  <a class="neonText2">CREATE USER zabbix@localhost IDENTIFIED BY zabbixpassword;</a> |#|#| Команда для создания УЗ "zabbix" с паролем "zabbixpassword"
  ------------
  <a class="neonText2">exit</a> |#|#| Команда для выхода из MariaDB
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  По желанию можно также скопировать конфигурационные файлы из старой ВМ в новую.
  Список конфигурационных фалов с их местонахождением:
  <a class="neonText3">/etc/zabbix/zabbix_server.conf
  zabbix_server.te
  /etc/zabbix/zabbix_agent2.conf</a>
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  7.3) Настройка конфигурационных файлов.
  ------------
  <a class="neonText2">nano /etc/zabbix/zabbix_server.conf</a> |#|#| Команда для открытия конфигурационного файла "zabbix_server.conf" в текстовом редакторе Nano
  ------------
  Приведите ниже описанные строки в открытом конфигурационном файле "zabbix_server.conf" к следующему виду, после внесённых изменений не забудьте сохраниить конфигурационный файл:
  <a class="neonText2">
  DBHost=localhost
  DBPassword=password</a>
  ------------
  <a class="neonText2">systemctl enable --now zabbix-server</a> |#|#| Команда для запуска указанного юнита и добавления службы "zabbix-server" в автозагрузку
  ------------
  ЕСЛИ НА ВАШЕМ УСТРОЙСТВЕ ВКЛЮЧЕНА СЛУЖБА SELINUX, ТО ВЫПОЛНИТЕ КОМАНДЫ ОПИСАННЫЕ НИЖЕ↓↓↓!!!
  ------------
  <a class="neonText2">setsebool -P zabbix_can_network on
  setsebool -P httpd_can_connect_zabbix on
  setsebool -P domain_can_mmap_files on
  setsebool -P daemons_enable_cluster_mode on</a>
  ------------
  <a class="neonText2">nano zabbix_server.te</a> |#|#| Данной командой создадим текстовый файл "zabbix_server.te"
  ------------
  Приведите конфигурационных файл к следующему виду и сохраните:
  <a class="neonText2">
  module zabbix_server 1.0;

  require {
          type initctl_t;
          type devlog_t;
          type proc_kcore_t;
          type zabbix_t;
          type zabbix_agent_t;
          type rpm_exec_t;
          type rpm_var_lib_t;
          class fifo_file getattr;
          class sock_file getattr;
          class file { execute execute_no_trans map open getattr };
          class capability dac_override;
}

  #============= zabbix_t ==============
  allow zabbix_t self:capability dac_override;

  #============= zabbix_agent_t ==============
  allow zabbix_agent_t devlog_t:sock_file getattr;
  allow zabbix_agent_t initctl_t:fifo_file getattr;
  allow zabbix_agent_t proc_kcore_t:file getattr;
  allow zabbix_agent_t rpm_var_lib_t:file open;
  allow zabbix_agent_t rpm_exec_t:file { execute execute_no_trans map };</a>
  ------------
  <a class="neonText2">checkmodule -m -M -o zabbix_server.mod zabbix_server.te
  semodule_package --outfile zabbix_server.pp --module zabbix_server.mod
  semodule -i zabbix_server.pp</a>
  ------------
  <a class="neonText2">firewall-cmd --add-service={http,https}</a> |#|#| Команда для открытия доступа трафику через протоколы HTTP/HTTPS
  ------------
  <a class="neonText2">firewall-cmd --add-port={10051/tcp,10050/tcp}</a> |#|#| Команда для открытия доступа трафику через порты 10051 по протоколу управления передачей данных TCP
  ------------
  <a class="neonText2">firewall-cmd --runtime-to-permanent</a> |#|#| Команда для сохранения конфигурации на межсетевом экране
  ------------
  <a class="neonText2">nano /etc/zabbix/zabbix_agent2.conf</a> |#|#| Команда для открытия конфигурационного файла "zabbix_agent2.conf" в текстовом редакторе Nano
  ------------
  Приведите ниже описанные строки в открытом конфигурационном файле "zabbix_agent2.conf" к следующему виду, после внесённых изменений не забудьте сохраниить конфигурационный файл:
  <a class="neonText2">
  Server=127.0.0.1
  ServerActive=127.0.0.1
  Hostname=Zabbix server</a>
  ------------
  <a class="neonText2">systemctl enable --now zabbix-agent2</a> |#|#| Команда для запуска указанного юнита и добавления службы "zabbix-agent2" в автозагрузку
  ------------
  <a class="neonText2">systemctl restart httpd php-fpm</a> |#|#| Команда для перезапуска служб "httpd" и "php-fpm"
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  8) Настройка/установка Zabbix через Zabbix Web-интерфейс.
  ------------
  1. Открываете браузер и переходите по адресу http://IP-address server-a/zabbix/ — откроется страница установки Zabbix Web и нажимаем на кнопку "Next Step"
  2. Далее внимательно смотрим на результаты проверки нашего Web-сервера — справа мы должны увидеть все OK. Когда все результаты будут OK, нажимаем на "Next Step"
  3. Далее настройки подключения к базе оставляем как есть — дополнительно прописываем пароль, который задали при создании пользователя zabbix. После нажимаем "Next Step"
  4. Далее в окне оставляем все как есть и нажимаем "Next Step"
  5. В последнем окне мы проверяем настройки и нажимаем "Next Step"
  6. После завершения установки нажимаем на кнопку "Finish"
  7. Для входа в систему используйте созданные УЗ в Zabbix на старой ВМ.
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  Выводы:

  1) Лучше всего устанавливать ПО Zabbix на чистую и обновленную ВМ с родными репозиториями, а после уже подключать дополнительные репозитории, такие как EPEL, REMI,
  ElRepo и т.п., для избежания конфликта устанавливаемых пакетов.
  
  2) В версии Zabbix 7.2.3 по сравнению с 7.0, перестала пропадать часть графика(просто не отрисовывалась).

  <img src="Error1.png">

  3) Также была исправлена следующая ошибка в триггерах элементов данных:
  <a class="neonText3">Undefined array key "disable_source" [zabbix.php:17 → require_once() → ZBase->run() → ZBase->processRequest() → ZBase->processResponseFinal() → CView->getOutput() →
  include() in app/views/trigger.list.php:289]</a>
  P.S. На момент установки Zabbix 7.0, также были установлены пакеты PHP версии 8.1.
  
  <img src="Error2.png">
  
  --------------------------------------------------------------------------------------------------------------------------------------------------------------
  На этом инструкция закончена! Спасибо за внимание!
  </p>
  </div>
